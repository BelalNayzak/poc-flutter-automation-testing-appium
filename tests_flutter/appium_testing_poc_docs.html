<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appium Flutter POC - Comprehensive Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 25px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #0d1b2a;
            border-bottom: 2px solid #e0e1dd;
            padding-bottom: 10px;
        }
        h1 { font-size: 2.2em; }
        h2 { font-size: 1.8em; margin-top: 40px; }
        h3 { font-size: 1.4em; margin-top: 30px; }
        .meta {
            background-color: #f1f3f5;
            padding: 10px 20px;
            border-left: 5px solid #0d1b2a;
            margin: 30px 0;
            border-radius: 4px;
        }
        .meta p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #495057;
        }
        .meta p strong {
            color: #0d1b2a;
        }
        code {
            background-color: #e9ecef;
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 90%;
            border-radius: 3px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        }
        pre {
            background-color: #212529;
            color: #e6f1ff;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* Style for code elements inside a pre block */
        pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            font-size: inherit;
            border-radius: 0;
        }
        .note, .warning {
            padding: 15px;
            margin-top: 20px;
            border-left-width: 5px;
            border-left-style: solid;
            border-radius: 4px;
        }
        .note {
            background-color: #e7f5ff;
            border-color: #228be6;
        }
        .warning {
            background-color: #fff4e6;
            border-color: #f76707;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        th {
            background-color: #f1f3f5;
        }
        ul, ol {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Appium Flutter POC - Comprehensive Documentation</h1>

        <div class="meta">
            <p><strong>Author: </strong>  Belal Ashraf  |  Sr. Flutter Developer</p>
            <p><strong>Version: </strong>  1.0</p>
            <p><strong>Date: </strong>  July 2, 2024</p>
        </div>

        <!-- Section 1: Project Overview -->
        <h2>1. Project Overview</h2>
        <p>This project is a Proof-of-Concept (POC) designed to demonstrate a complete workflow for setting up and running automated tests for a Flutter application using Appium. It integrates Flutter (for the mobile app), Python with <code>pytest</code> (for writing and running tests), and the <strong>Appium Flutter Driver</strong> to bridge the two.</p>
        <p>The primary goal is to establish a reliable, repeatable process for mobile test automation and to document the solutions to common challenges encountered during setup.</p>

        <!-- Section 2: Appium Flutter Driver Details -->
        <h2>2. Understanding the Appium Flutter Driver</h2>
        <p>The magic behind this testing setup is the <code>appium-flutter-driver</code>. It's an Appium driver that allows you to automate Flutter applications by leveraging Flutter's own testing and debugging capabilities.</p>
        
        <h3>Key Concepts</h3>
        <ul>
            <li>
                <strong>Dart VM Service (Observatory):</strong> When a Flutter app is run in debug mode, it starts a web server called the Dart VM Service. This service exposes a WebSocket interface that allows tools to inspect the running application, view the widget tree, and control its behavior. This is the entry point for Appium.
            </li>
            <li>
                <strong>Service Authentication Codes:</strong> Since Flutter 3.7, the Dart VM Service is protected by a security token (an "auth code") by default. The URL looks like <code>http://127.0.0.1:PORT/AUTH_CODE=/</code>. If the Appium driver tries to connect without this auth code, it gets an <code>HTTP 302 Redirect</code> error. The easiest workaround for local testing is to disable this feature using the <code>--disable-service-auth-codes</code> flag when running the Flutter app.
            </li>
            <li>
                <strong>ADB Port Forwarding:</strong> The Dart VM Service runs on the Android device/emulator, not on your local machine. To make it accessible to Appium (which runs on your machine), you must forward a local port to the device's port using the Android Debug Bridge (<code>adb</code>). For example: <code>adb forward tcp:60000 tcp:60000</code>.
            </li>
        </ul>
        <div class="note">
            <strong>Key takeaway:</strong> The entire process relies on Appium successfully connecting to the Dart VM Service's WebSocket. Any issue with port forwarding, auth codes, or driver versions will break this connection.
        </div>

        <!-- Section 3: File Structure and Code Documentation -->
        <h2>3. Code Documentation and File Structure</h2>
        <p>The project is organized to separate the Flutter application from the Python test suite.</p>

        <h3>Flutter App: <code>lib/main.dart</code></h3>
        <p>The Flutter application is a simple, single-screen UI with input fields and a button. The most important aspect for testing is the use of <code>ValueKey</code> on widgets. These keys provide stable, unique locators for Appium to find elements, which is far more reliable than finding by text or type.</p>
        <pre><code>// Example from lib/main.dart
TextFormField(
  key: const ValueKey('phone_field'),
  // ...
),</code></pre>

        <h3>Test Suite: <code>tests_flutter/</code></h3>
        <table>
            <thead>
                <tr>
                    <th>File / Directory</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>run_tests.py</code></td>
                    <td>A Python script that orchestrates the test run. It checks for dependencies (like a running Appium server) and uses <code>pytest</code> to execute the test files. It also generates an HTML report.</td>
                </tr>
                <tr>
                    <td><code>conftest.py</code></td>
                    <td>A core pytest file for setting up shared test fixtures. The <code>driver_android</code> fixture is defined here. It configures the Appium capabilities (e.g., platform, device, app package) and initializes the Appium driver session.</td>
                </tr>
                <tr>
                    <td><code>test_login.py</code></td>
                    <td>Contains the actual test cases. It uses the Page Object Model (POM) to interact with the app and makes assertions to verify behavior (e.g., checking if an error message appears).</td>
                </tr>
                <tr>
                    <td><code>pages/login_page.py</code></td>
                    <td>Implements the Page Object Model. It centralizes the element locators (finding by <code>ValueKey</code>) and the methods for interacting with the login screen (e.g., <code>enter_phone()</code>, <code>tap_login()</code>). This makes tests cleaner and easier to maintain.</td>
                </tr>
                <tr>
                    <td><code>requirements.txt</code></td>
                    <td>Lists all the required Python packages for the test suite (e.g., <code>Appium-Python-Client</code>, <code>pytest</code>, <code>pytest-html</code>).</td>
                </tr>
                <tr>
                    <td><code>run_flutter_appium_tests.sh</code></td>
                    <td>An automated shell script that attempts to run the entire workflow. <strong>It is currently unreliable</strong> due to timing and process management issues with <code>flutter run</code>. It serves as a good example of the challenges in fully automating this process without more advanced tools.</td>
                </tr>
            </tbody>
        </table>

        <!-- Section 4: The Reliable Manual Workflow -->
        <h2>4. The Reliable Manual Workflow to Execute Tests</h2>
        <p>This step-by-step process is the most reliable way to run the tests, as it avoids the timing and process management issues of a fully automated script. Follow it exactly.</p>

        <ol>
            <li>
                <strong>Clean Slate: Kill All Old Processes</strong>
                <p>Ensure no old processes are running that could interfere. Open a terminal and run:</p>
                <pre><code>killall -9 dart flutter node appium || true</code></pre>
                <div class="note">The <code>|| true</code> prevents an error if no processes are found.</div>
            </li>
            <li>
                <strong>Start Emulator/Device</strong>
                <p>Make sure your Android emulator is running and unlocked. Verify it's connected with:</p>
                <pre><code>adb devices</code></pre>
            </li>
            <li>
                <strong>Start the Flutter App</strong>
                <p>In a new terminal, navigate to the project root and run the app with service auth codes disabled:</p>
                <pre><code>flutter run --debug --disable-service-auth-codes</code></pre>
                <p><strong>CRITICAL:</strong> Wait for the output and find the Dart VM Service URL. This is the most important step.</p>
                <pre><code>A Dart VM Service on sdk gphone64 arm64 is available at:
http://127.0.0.1:60693/</code></pre>
                <p>Leave this terminal running.</p>
            </li>
            <li>
                <strong>Forward the Correct Port</strong>
                <p>Using the port from the previous step (e.g., <code>60693</code>), open a new terminal and forward it:</p>
                <pre><code># Replace 60693 with your actual port
adb forward --remove tcp:60693
adb forward tcp:60693 tcp:60693</code></pre>
            </li>
            <li>
                <strong>Start the Appium Server</strong>
                <p>In another new terminal, start Appium:</p>
                <pre><code>appium</code></pre>
                <p><strong>Sanity Check:</strong> Wait until you see the log message <code>[Appium] Appium REST http interface listener started on http://0.0.0.0:4723</code>. If you get an <code>EADDRINUSE</code> error, it means Appium is already running, which is fine.</p>
            </li>
            <li>
                <strong>Activate Python Environment and Run Tests</strong>
                <p>In a final terminal, navigate to the project root, activate the virtual environment, and run the tests:</p>
                <pre><code># Navigate to the project root first
cd /path/to/appium_testing_poc

# Activate venv
source tests_flutter/venv/bin/activate

# Go to tests directory
cd tests_flutter

# Run the tests
python run_tests.py</code></pre>
            </li>
        </ol>

        <!-- Section 5: Troubleshooting -->
        <h2>5. Troubleshooting Common Issues</h2>
        <table>
            <thead>
                <tr>
                    <th>Error Message</th>
                    <th>Cause</th>
                    <th>Solution</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>Cannot connect to the Dart Observatory URL...</code></td>
                    <td>The port forwarding is incorrect (mismatched port) or was not set up for the current Flutter session.</td>
                    <td>Stop and restart the process. Ensure you are using the <strong>current port</strong> from the <code>flutter run</code> output for your <code>adb forward</code> command.</td>
                </tr>
                <tr>
                    <td><code>...Unexpected server response: 302</code></td>
                    <td>Flutter's Observatory requires a service auth code, and the driver is not providing it.</td>
                    <td>Run your app with the <code>--disable-service-auth-codes</code> flag. If the issue persists, update your <code>appium-flutter-driver</code>.</td>
                </tr>
                <tr>
                    <td><code>adb: error: cannot bind listener: Address already in use</code></td>
                    <td>The local port you are trying to use for forwarding is already occupied on your machine.</td>
                    <td>Use a different local port for forwarding. Example: <code>adb forward tcp:7001 tcp:60693</code>. You would then need to update your Appium capabilities to point to port <code>7001</code>.</td>
                </tr>
                <tr>
                    <td><code>[Appium] Error: listen EADDRINUSE...</code></td>
                    <td>An Appium server is already running on the default port (4723).</td>
                    <td>This is not a fatal error. It just means you don't need to start a new Appium instance. Proceed with running your tests.</td>
                </tr>
                <tr>
                    <td><code>Appium server is not running</code></td>
                    <td>The test runner's check failed to find a running Appium server before executing tests.</td>
                    <td>Start the Appium server manually in a separate terminal with the <code>appium</code> command.</td>
                </tr>
            </tbody>
        </table>

    </div>
</body>
</html> 